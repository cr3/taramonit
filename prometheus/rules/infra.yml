groups:
- name: infra
  rules:
  - alert: TargetDown
    expr: up == 0
    for: 5m
    labels:
      severity: page
    annotations:
      summary: "Target down (job={{ $labels.job }}, instance={{ $labels.instance }})"
      description: "Prometheus cannot scrape {{ $labels.job }} on {{ $labels.instance }} for 5m."

  - alert: AlertmanagerDown
    expr: up{job=~".*alertmanager.*"} == 0
    for: 5m
    labels:
      severity: page
    annotations:
      summary: "Alertmanager down"
      description: "Prometheus cannot scrape Alertmanager for 5m."

  - alert: NodeFilesystemLowSpace
    expr: |
      (node_filesystem_avail_bytes{fstype!~"tmpfs|overlay"} /
       node_filesystem_size_bytes{fstype!~"tmpfs|overlay"}) < 0.10
      and node_filesystem_readonly{fstype!~"tmpfs|overlay"} == 0
    for: 15m
    labels:
      severity: page
    annotations:
      summary: "Low disk space (instance={{ $labels.instance }}, mount={{ $labels.mountpoint }})"
      description: "Less than 10% disk available for 15m."

  - alert: NodeMemoryLow
    expr: (node_memory_MemAvailable_bytes / node_memory_MemTotal_bytes) < 0.10
    for: 15m
    labels:
      severity: warn
    annotations:
      summary: "Low memory available (instance={{ $labels.instance }})"
      description: "Less than 10% memory available for 15m."

  - alert: ScrapeDurationHigh
    expr: max_over_time(scrape_duration_seconds[5m]) > 5
    for: 10m
    labels:
      severity: warn
    annotations:
      summary: "High scrape duration"
      description: "A target scrape took >5s for 10m. Check scrape_interval and heavy exporters (often cAdvisor)."
